---
import { Image } from 'astro:assets';
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import Header from '../../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../../consts';

export async function getStaticPaths() {
	const photos = await getCollection('photos');
	return photos.map((photo) => ({
		params: { slug: photo.id },
		props: photo,
	}));
}

type Props = CollectionEntry<'photos'>;

const photo = Astro.props as Props;
const { Content } = await render(photo);
const photos = (await getCollection('photos')).sort(
	(a, b) => b.data.capturedDate.valueOf() - a.data.capturedDate.valueOf(),
);
const photoIndex = photos.findIndex((entry) => entry.id === photo.id);
const prevPhoto = photoIndex > 0 ? photos[photoIndex - 1] : null;
const nextPhoto = photoIndex >= 0 && photoIndex < photos.length - 1 ? photos[photoIndex + 1] : null;
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={`${SITE_TITLE} | ${photo.data.title}`} description={photo.data.description ?? SITE_DESCRIPTION} />
		<meta name="view-transition" content="same-origin" />
	</head>
	<body class="photo-detail">
		<Header />
		<main>
			<section class="page-intro">
				<p class="tagline">Photo</p>
				<h1 class="photo-detail__title">{photo.data.title}</h1>
				<p class="photo-detail__description">{photo.data.description}</p>
			</section>

			<section>
				<div class="post-meta photo-detail__meta">
					<FormattedDate date={photo.data.capturedDate} />
					{photo.data.location ? ` • ${photo.data.location}` : ''}
					{photo.data.camera ? ` • ${photo.data.camera}` : ''}
				</div>
				<div class="post-hero">
					<button
						class="photo-lightbox-trigger"
						type="button"
						aria-label={`Open full-size image of ${photo.data.title}`}
					>
						<Image class="post-hero__image" src={photo.data.heroImage} alt={photo.data.title} width={1200} height={900} />
					</button>
				</div>
				<div class="lightbox" aria-hidden="true">
					<div class="lightbox__backdrop" data-lightbox-close></div>
					<div class="lightbox__content" role="dialog" aria-modal="true" aria-label={`Full-size image of ${photo.data.title}`}>
						<button class="lightbox__close" type="button" aria-label="Close image" data-lightbox-close>
							<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.6">
								<line x1="6" y1="6" x2="18" y2="18" />
								<line x1="6" y1="18" x2="18" y2="6" />
							</svg>
						</button>
						<img class="lightbox__image" src={photo.data.heroImage.src} alt={photo.data.title} loading="lazy" />
					</div>
				</div>
				<div class="prose">
					<Content />
				</div>
			</section>
		</main>
		<Footer />
		<script
			is:inline
			define:vars={{
				prevLink: prevPhoto ? `/photos/${prevPhoto.id}/` : null,
				nextLink: nextPhoto ? `/photos/${nextPhoto.id}/` : null,
			}}
		>
			const image = document.querySelector('.post-hero__image');
			const lightbox = document.querySelector('.lightbox');
			const lightboxTriggers = document.querySelectorAll('.photo-lightbox-trigger');
			const lightboxClose = document.querySelectorAll('[data-lightbox-close]');
			const root = document.documentElement;
			const enableGlow = () => {
				root.classList.remove('photo-glow-active');
				requestAnimationFrame(() => {
					root.classList.add('photo-glow-active');
				});
			};
			const storedGlow = sessionStorage.getItem('photoGlow');
			if (storedGlow) {
				try {
					const { top, bottom } = JSON.parse(storedGlow);
					if (top && bottom) {
						root.style.setProperty('--accent-glow', top);
						root.style.setProperty('--accent-secondary-glow', bottom);
						enableGlow();
					}
				} catch (error) {
					sessionStorage.removeItem('photoGlow');
				}
			}
			if (image) {
				const applyGlow = () => {
					const canvas = document.createElement('canvas');
					const ctx = canvas.getContext('2d', { willReadFrequently: true });
					if (!ctx) return;
					const size = 24;
					canvas.width = size;
					canvas.height = size;
					ctx.drawImage(image, 0, 0, size, size);
					const data = ctx.getImageData(0, 0, size, size).data;

					const sampleEdge = (edge) => {
						let r = 0;
						let g = 0;
						let b = 0;
						let count = 0;
						for (let i = 0; i < size; i++) {
							let idx;
							if (edge === 'top') idx = i * 4;
							if (edge === 'bottom') idx = ((size - 1) * size + i) * 4;
							if (edge === 'left') idx = i * size * 4;
							if (edge === 'right') idx = (i * size + (size - 1)) * 4;
							r += data[idx];
							g += data[idx + 1];
							b += data[idx + 2];
							count += 1;
						}
						return {
							r: Math.round(r / count),
							g: Math.round(g / count),
							b: Math.round(b / count),
						};
					};

					const top = sampleEdge('top');
					const bottom = sampleEdge('bottom');
					const topColor = `rgba(${top.r}, ${top.g}, ${top.b}, 0.8)`;
					const bottomColor = `rgba(${bottom.r}, ${bottom.g}, ${bottom.b}, 0.6)`;
					root.style.setProperty('--accent-glow', topColor);
					root.style.setProperty('--accent-secondary-glow', bottomColor);
					enableGlow();
					sessionStorage.setItem('photoGlow', JSON.stringify({ top: topColor, bottom: bottomColor }));
				};

				if (image.complete) {
					applyGlow();
				} else {
					image.addEventListener('load', applyGlow, { once: true });
				}
			}

			const openLightbox = () => {
				if (!lightbox) return;
				lightbox.classList.add('is-open');
				lightbox.setAttribute('aria-hidden', 'false');
				document.body.style.overflow = 'hidden';
			};

			const closeLightbox = () => {
				if (!lightbox) return;
				lightbox.classList.remove('is-open');
				lightbox.setAttribute('aria-hidden', 'true');
				document.body.style.overflow = '';
			};

			lightboxTriggers.forEach((trigger) => {
				trigger.addEventListener('click', openLightbox);
			});

			lightboxClose.forEach((button) => {
				button.addEventListener('click', closeLightbox);
			});

			window.addEventListener('keydown', (event) => {
				if (event.key === 'Escape') closeLightbox();
				if (event.key === 'ArrowLeft' && prevLink) {
					navigateTo(prevLink);
				}
				if (event.key === 'ArrowRight' && nextLink) {
					navigateTo(nextLink);
				}
			});

			const navigateTo = (href) => {
				if (!href) return;
				const start = document.startViewTransition;
				if (typeof start === 'function') {
					try {
						start(() => {
							window.location.assign(href);
						});
						return;
					} catch (error) {
						// fall through to the fade-out fallback
					}
				}
				document.body.classList.add('photo-transition-out');
				setTimeout(() => window.location.assign(href), 260);
			};
		</script>
	</body>
</html>
